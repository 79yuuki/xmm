<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>XMM</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css" rel="stylesheet">

<style>
#output {
	white-space: pre-wrap;
}
</style>

<script src="https://code.jquery.com/jquery.js"></script>

<script>
let id, output;

function request(action, param, callback)
{
	const api = "https://data.ripple.com/v2/accounts/";

	$.getJSON(api + id + "/" + action, param, callback);
}

function getstate(list)
{
	const dict = list.reduce((acc, line) => {
		const balance = acc.balance;
		const value = parseFloat(line.value);
		let asset = line.currency;

		if (value > 0) {
			const issuer = line.counterparty;

			if (issuer)
				asset += "." + issuer;

			balance[asset] = value;

			acc.product *= value;
			++acc.count;
		} else if (value < 0) {
			asset += "." + id;

			if (balance[asset])
				balance[asset] += value;
			else
				balance[asset] = value;

			acc.iou += -value;
		}

		return acc;
	}, {
		product: 1,
		count: 0,
		iou: 0,
		balance: {}
	});

	dict.gm = Math.pow(dict.product, 1 / dict.count);
	dict.proper = dict.gm / dict.iou;
	return dict;
}

function getsteps(list)
{
	const dict = list.reduce((acc, line) => {
		const value = parseFloat(line.amount_change);
		const issuer = line.counterparty;
		const time = line.executed_time;
		let asset = line.currency;
		let entry = acc.current;
		let delta = entry.delta;
		let ready = false;

		if (issuer)
			asset += "." + issuer;

		if (entry.time != time)
			if (Object.keys(acc.tx).length > 1)
				ready = true;

		if (ready) {
			acc.steps.push(entry);

			delta = {};
			entry = {
				delta: delta
			};
			acc.current = entry;
			acc.tx = {};
		}

		if ("exchange" == line.change_type)
			acc.tx[asset] = true;

		if (delta[asset])
			delta[asset] += value;
		else
			delta[asset] = value;

		entry.time = time;
		return acc;
	}, {
		tx: {},
		current: {
			delta: {}
		},
		steps: []
	});

	return dict.steps;
}

function setup()
{
	const header = $("#header");
	const root = header.text();

	id = location.hash.replace("#", "");
	if (!id) {
		id = prompt("Ripple address", root);
		location.replace("#" + id);
	}

	header.text(id);

	output = $("#output");

	request("balances", data => {
		data = getstate(data.balances);
		data = JSON.stringify(data, null, "\t");
		output.prepend(data + "\n");
	});

	request("balance_changes", {
		descending: true,
		limit: 1e3
	}, data => {
		data = getsteps(data.balance_changes);
		data = JSON.stringify(data, null, "\t");
		output.append("\n" + data);
	});
}

$(setup);
</script>
</head>

<body>
<div class="container-fluid">
<div class="row">
<div class="col-sm-10 col-sm-offset-1">
<h1>
<small>
<samp id="header">rHb9CJAWyB4rj91VRWn96DkukG4bwdtyTh</samp>
</small>
</h1>

<p>
<samp id="output"></samp>
</p>

<hr>
</div>
</div>
</div>
</body>
</html>
