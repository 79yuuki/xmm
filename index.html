<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>XMM</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css" rel="stylesheet">

<style>
#output {
	white-space: pre-wrap;
}
</style>

<script src="https://code.jquery.com/jquery.js"></script>

<script>
let id;

function request(action, param)
{
	const api = "https://data.ripple.com/v2/accounts/";

	if (!param)
		param = {};

	return new Promise((resolve, reject) => {
		$.ajax({
			dataType: "json",
			url: api + id + "/" + action,
			data: param,
			success: resolve,
			error: reject
		});
	});
}

function getvalue(balance, iou)
{
	let p = 1;
	let n = 0;

	for (const asset in balance) {
		p *= balance[asset];
		++n;
	}

	return Math.pow(p, 1 / n) / iou;
}

function getstate(list)
{
	const dict = list.reduce((acc, line) => {
		const value = parseFloat(line.value);
		let asset = line.currency;

		if (value > 0) {
			const issuer = line.counterparty;

			if (issuer)
				asset += "." + issuer;

			acc.balance[asset] = value;
		} else {
			asset += "." + id;
			acc.iou += -value;
		}

		return acc;
	}, {
		iou: 0,
		balance: {}
	});

	dict.value = getvalue(dict.balance, dict.iou);
	return dict;
}

function getsteps(list)
{
	const dict = list.reduce((acc, line) => {
		const value = parseFloat(line.amount_change);
		const issuer = line.counterparty;
		const time = line.executed_time;
		let asset = line.currency;
		let entry = acc.current;
		let delta = entry.delta;
		let ready = false;

		if (issuer)
			asset += "." + issuer;

		if (entry.time != time)
			if (Object.keys(acc.tx).length > 1)
				ready = true;

		if (ready) {
			acc.steps.push(entry);

			delta = {};
			entry = {
				delta: delta
			};
			acc.current = entry;
			acc.tx = {};
		}

		if ("exchange" == line.change_type)
			acc.tx[asset] = true;

		if (delta[asset])
			delta[asset] += value;
		else
			delta[asset] = value;

		entry.time = time;
		return acc;
	}, {
		tx: {},
		current: {
			delta: {}
		},
		steps: []
	});

	return dict.steps;
}

function addline(step)
{
	$("#output").append([
		step.time,
		step.proper.toPrecision(7),
		step.growth.toFixed(2) + "bp"
	].join("\t") + "\n");
}

function revert(state, step)
{
	const balance = Object.assign({}, state.balance);
	const delta = step.delta;
	const iou = state.iou;
	const proper = state.value;
	let value, growth;

	for (const asset in delta)
		if (balance[asset])
			balance[asset] -= delta[asset];

	value = getvalue(balance, iou);
	growth = 1e4 * (proper / value - 1);

	return {
		time: step.time,
		shares: iou,
		iou: iou,
		balance: balance,
		value: value,
		proper: proper,
		growth: growth
	};
}

function show(state, steps)
{
	steps.reduce((acc, line) => {
		const step = revert(acc, line);

		addline(step);

		return step;
	}, state);

	$("#view").show();
}

function setup()
{
	const header = $("#header");
	const root = header.text();

	id = location.hash.replace("#", "");
	if (!id) {
		id = prompt("Ripple address", root);
		location.replace("#" + id);
	}

	header.text(id);

	Promise.all([
		request("balances"),
		request("balance_changes", {
			descending: true,
			limit: 1e3
		})
	]).then(data => {
		const balance = data[0].balances;
		const changes = data[1].balance_changes;
		const state = getstate(balance);
		const steps = getsteps(changes);

		show(state, steps);
	}).catch(reason => {
		const json = reason.responseJSON;

		if (json)
			reason = "Error: " + json.message;
		else
			reason = "Unknown error";

		$("#error").text(reason);
		$("#alert").show();
	});
}

$(setup);
</script>
</head>

<body>
<div class="container-fluid">
<div class="row">
<div class="col-sm-10 col-sm-offset-1">
<div class="page-header">
<h1>
<small>
<samp id="header">rHb9CJAWyB4rj91VRWn96DkukG4bwdtyTh</samp>
</small>
</h1>
</div>

<div id="alert" class="alert alert-danger" hidden>
<strong id="error"></strong>
</div>

<div id="view" class="well" hidden>
<samp id="output"></samp>
</div>
</div>
</div>
</div>
</body>
</html>
