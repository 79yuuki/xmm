<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>XMM</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css" rel="stylesheet">

<style>
#output {
	white-space: pre-wrap;
}
</style>

<script src="https://code.jquery.com/jquery.js"></script>

<script>
const balance = {};
const changes = {};
let id, output;

function request(action, param, callback)
{
	const api = "https://data.ripple.com/v2/accounts/";

	$.getJSON(api + id + "/" + action, param, callback);
}

function proper()
{
	let iou = 1;
	let n = 0;
	let p = 1;

	for (const asset in balance) {
		const value = balance[asset];

		if (value < 0) {
			iou = -value;
			continue;
		}

		p *= value;
		++n;
	}

	return Math.pow(p, 1 / n) / iou;
}

function setline(line)
{
	const value = parseFloat(line.value);
	let asset = line.currency;

	if (value > 0) {
		const issuer = line.counterparty;

		if (issuer)
			asset += "." + issuer;

		balance[asset] = value;
	} else if (value < 0) {
		asset += "." + id;

		if (balance[asset])
			balance[asset] += value;
		else
			balance[asset] = value;
	}
}

function addstep(step)
{
	const value = parseFloat(step.amount_change);
	const issuer = step.counterparty;
	const time = step.executed_time;
	let asset = step.currency;
	let entry = changes[time];

	if (!entry) {
		entry = {};
		changes[time] = entry;
	}

	if (issuer)
		asset += "." + issuer;

	entry[asset] = value;
}

function setup()
{
	const header = $("#header");
	const root = header.text();

	id = location.hash.replace("#", "");
	if (!id) {
		id = prompt("Ripple address", root);
		location.replace("#" + id);
	}

	header.text(id);

	output = $("#output");

	request("balances", data => {
		data.balances.forEach(setline);
		data = JSON.stringify(balance, null, "\t");
		output.prepend(data + "\n");
		output.prepend(proper() + "\n\n");
	});

	request("balance_changes", {
		descending: true,
		limit: 1e3
	}, data => {
		data.balance_changes.forEach(addstep);
		data = JSON.stringify(changes, null, "\t");
		output.append("\n" + data);
	});
}

$(setup);
</script>
</head>

<body>
<div class="container-fluid">
<div class="row">
<div class="col-sm-10 col-sm-offset-1">
<h1>
<small>
<samp id="header">rHb9CJAWyB4rj91VRWn96DkukG4bwdtyTh</samp>
</small>
</h1>

<p>
<samp id="output"></samp>
</p>

<hr>
</div>
</div>
</div>
</body>
</html>
